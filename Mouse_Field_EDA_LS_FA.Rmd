---
title: "Mouse_Field_EDA_LS_FA"
author: "Cass Lee"
date: "2025-09-17"
output: pdf_document
---


! For best results, run these code chunks sequentially in RStudio rather than creating a knitted document.

## Preliminary Set Up

```{r import libraries}
# import useful libraries
library(tidyverse)
library(mosaic)
library(ggformula)
library(dplyr)
library(lme4)
library(effects)
```

```{r import data}
# set import file path
path_m <- '~/Desktop/ENVR356/LS_FA/MouseDataDraft.tsv'
# import full data set
all_data_m <- read_tsv(file = path_m,col_types = "nnccntcncccccc")
  # skip the two header rows
# change the column names
names(all_data_m) <- c("Site","Camera","SD","Month","Day","Time","FileName","NumMice","Left","Right","Majority","Rat","Notes","Observer","drop")

all_data_m <- all_data_m |> select(-drop)
```

```{r}
# problems get generated because of the videos where the date was wrong bc the camera had problems
subset(all_data_m, is.na(Time))
all_data_m <- all_data_m[!is.na(all_data_m$Time),]
```

```{r}
glimpse(all_data_m)
```

```{r}
# make analysis data frame
analysis_data_m <- all_data_m |> 
  # subset to only include observations with mice
  subset(NumMice > 0) |>
  # transform the data to account for video length
  # need to account for error in the human fallible timing...
  # there are so few rat videos that rather than timer we could maybe manually get the durations using video trimming clips
# for now, proportion can be bigger than 1 ig
  mutate(
  MonthNum = case_when(Month == "Jul" ~ 7,
                         Month == "Aug" ~ 8,
                         Month == "Sep" ~ 9,
                         .default = NA),
  Date = as.POSIXct(paste("2025",MonthNum,Day,Time,sep=":"), tz="","%Y:%m:%d:%H:%M:%S"),
  Period = case_when(Date < as.POSIXct("2025-07-28",tz="","%Y-%m-%d") ~ 1,
                     Date > as.POSIXct("2025-08-18",tz="","%Y-%m-%d") ~ 3,
                     .default = 2),
  ServiceInterval = case_when(Period==1 ~ difftime(Date, as.POSIXct("2025-07-09",tz="","%Y-%m-%d"),units="days"),
                     Period==2 ~ difftime(Date, as.POSIXct("2025-07-28",tz="","%Y-%m-%d"),units="days"),
                     .default = difftime(Date, as.POSIXct("2025-08-18",tz="","%Y-%m-%d"),units="days")))
```

```{r}
# separate out the different mice
analysis_data_m <- analysis_data_m |> separate_longer_delim(c(Left,Right,Majority),",") |>
  mutate(Left = as.numeric(Left), Right = as.numeric(Right))

# get only the entries with multiple mice
#multiple_mice <- analysis_data_m |> subset(NumMice > 1) 
#|>
  #mutate(MouseNum)
  # make extra rows so each mouse has own line
  #slice(rep(row_number(),NumMice))
  
#multiple_mice |> separate_longer_delim(c(Left,Right,Majority),",")

#multiple_mice

#rep()
#slice(rep(row_number()))

#head(multiple_mice) |> slice(rep(row_number(),NumMice))

#row_
```

```{r}
# automatically fill in the left tube treatment based on period and site
treatments <- data.frame(Period=rep(1:3,each=10),Site=rep(1:10,3), LeftTubeTreatment=c("M","C","M","M","C","P","M","C","P","P",
                    "C","M","P","P","M","P","P","M","C","C",
                    "C","P","P","M","P","C","P","P","C","M"))

analysis_data_m <- left_join(analysis_data_m,treatments)

```

```{r}
analysis_data_m <- analysis_data_m |>
  mutate(FirstBait = case_when(Left=="1" ~ LeftTubeTreatment, # if the first tube was the left then record the left treatment
                        Right=="1" & LeftTubeTreatment == "M" ~ "P", # if the first tube was the right and the left tube had mayo then record peanut butter as the first bait
                        Right=="1" & LeftTubeTreatment == "P" ~ "M", # if the first tube was the right and the left tube had peanut butter then record mayo as the first bait
                        Right=="1" & LeftTubeTreatment == "C" ~ "C", # if the first tube was the right and the left tube was control then record control as the first bait
                        .default = NA)) # otherwise, no first bait
```

# First Interaction
```{r}
#We also performed a similar analysis for mouse bait preference measured as first interaction choice.
```

```{r}
# mixed model to predict first bait with the time since servicing
glmer(FirstBait ~ ServiceInterval + (1 | Period),family="binomial",data=ungroup(analysis_data_m))
  # make a neither level for first bait
  # subset the analysis data to exclude things with no mice

tally(~Period,data=analysis_data_m)
tally(~FirstBait,data=analysis_data_m)
tally(~FirstBait+Period,data=analysis_data_m)
table(analysis_data_m[,c("FirstBait","Period")])
# TODO this is really weird and something is wrong

# We used a logistic mixed effects model with the same random effects and the fixed effect of time since service to predict which bait type would be chosen first.
```

```{r}
# visualize first bait mixed model
gf_boxplot(FirstBait ~ ServiceInterval, fill=~FirstBait,data=analysis_data_m) + scale_fill_manual(values = c("springgreen3","dodgerblue","darkorange2","grey")) + theme_classic()

gf_histogram(~ServiceInterval, fill=~FirstBait,data=analysis_data_m,position="identity") + scale_fill_manual(values = c("springgreen3","dodgerblue","darkorange2","grey")) + theme_classic()
```

# Proportion Interactions
```{r}
#Additionally, for mice we calculated the mean proportion of interactions for each bait type and for the controls and used an ANOVA to evaluate significance.

# mean number of interactions for each bait type
# count number of mayo interactions, pb interactions, control interactions
#TODO
```

```{r}
# TODO definitely have to add the mice together before this point

# 18 control tubes total
# 21 mayo, 21 pb

# probably need to transform the data for this?
# summarize the count of 
# sum number of 

mayo_interactions <- (analysis_data_m$LeftTubeTreatment=="M" & analysis_data_m$Left>0) | (analysis_data_m$LeftTubeTreatment=="P" & analysis_data_m$Right>0)

pb_interactions <- (analysis_data_m$LeftTubeTreatment=="P" & analysis_data_m$Left>0) | (analysis_data_m$LeftTubeTreatment=="M" & analysis_data_m$Right>0)

control_interactions <- c((analysis_data_m$LeftTubeTreatment=="C" & analysis_data_m$Left>0), (analysis_data_m$LeftTubeTreatment=="C" & analysis_data_m$Right>0))

interactions_m <- data.frame(
  Treatment = c(rep("C",length(control_interactions)), rep("M",length(mayo_interactions)),rep("P",length(pb_interactions))), 
  Interaction = c(control_interactions,mayo_interactions,pb_interactions))

# mayo count
mayo_count <- sum((analysis_data_m$LeftTubeTreatment=="M" & analysis_data_m$Left>0) | (analysis_data_m$LeftTubeTreatment=="P" & analysis_data_m$Right>0), na.rm=TRUE)
# peanut butter count
pb_count <- sum((analysis_data_m$LeftTubeTreatment=="P" & analysis_data_m$Left>0) | (analysis_data_m$LeftTubeTreatment=="M" & analysis_data_m$Right>0), na.rm=TRUE)
# control count
control_count <- sum((analysis_data_m$LeftTubeTreatment=="C" & analysis_data_m$Left>0), na.rm=TRUE) + sum((analysis_data_m$LeftTubeTreatment=="C" & analysis_data_m$Right>0), na.rm=TRUE)

#sum(analysis_data_m$Right>0)
#nrow(analysis_data_m[analysis_data_m$Right>0,])
#length(analysis_data_m[analysis_data_m$Right>0])

#nrow(subset(analysis_data_m, Right>0))

#count

#print(analysis_data_m[analysis_data_m$Right>0,])

#sum(analysis_data_m$Right > 0, na.rm=TRUE)

#sum(
#  case_when(analysis_data_m,
            # if the left bait is mayo and there's an interaction on the left
            # if the left bait is pb and there's an interaction on the right
    
#  ))

#sum(case_when(analysis_data_m,
#              LeftTubeTreatment == "C"))
```

```{r}
interaction_stats <- data.frame(Treatment=c("Control","Mayo","Peanut butter"), InteractionCount=c(control_count,mayo_count,pb_count),InteractionMean=c(control_count/18,mayo_count/21,pb_count/21))
```

```{r}
# anova
  # probably need to actually do kruskal-wallis
  # count of number interactions / number of tubes
  # groups are control, mayo, pb, none
interaction_anova_m <- aov(InteractionMean ~ Treatment,data=interaction_stats)
summary(interaction_anova_m)
#TODO need to make it so that there is variation within groups
interaction_anova_m <- aov(Interaction ~ Treatment,data=interactions_m)
summary(interaction_anova_m)
```

```{r}
# visualize the stuff
gf_col(InteractionMean~Treatment,fill=~Treatment, data=interaction_stats) |>
  gf_labs(y = "Mean interactions per tube") + 
  scale_fill_manual(values = c("springgreen3","dodgerblue","darkorange2","grey")) + theme_classic()
#TODO add error bars somehow or smth


#gf_bar(Interaction~Treatment,data=interactions_m)

# boxplot
#gf_boxplot(as.numeric(Interaction)~Treatment,data=interactions_m)
```

